@using System.Reactive.Disposables
@using RZ.Foundation.BlazorViews.Shells
@using Microsoft.AspNetCore.Components.Sections
@using Microsoft.Extensions.Logging
@using ReactiveUI
@using RZ.Foundation.Blazor.Helpers
@inherits ReactiveInjectableComponentBase<ShellViewModel>

@inject NavigationManager NavManager
@inject ShellViewModel Shell
@inject ISnackbar Snackbar
@inject ILogger<ShellView> Logger

<MudThemeProvider Theme="Theme" @bind-IsDarkMode="ViewModel!.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider BackdropClick="false" />
<MudSnackbarProvider />

<MudLayout Class="screen-height">
    <ShellAppBar ViewModel="ViewModel" />
    <ShellNavMenu ViewModel="menuVm" />
    <MudMainContent Class="max-height">
        <SectionOutlet SectionName="content-top"/>

        <MudContainer MaxWidth="@(MaxWidth ?? MudBlazor.MaxWidth.False)" Class="max-height">
            <ShellViewContent ViewModel="ViewModel!"/>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {

    [Parameter] public MudTheme? Theme { get; set; }
    [Parameter] public MaxWidth? MaxWidth { get; set; }

    ShellNavMenuViewModel menuVm = default!;

    public ShellView() {
        this.WhenActivated(disposables => {
            Shell.Notifications
                 .Subscribe(m => Snackbar.Add(m.Message, m.Severity.ToMudSeverity()))
                 .DisposeWith(disposables);
            menuVm = new(Shell);
            var toPath = NavManager.Path();

            Logger.LogDebug("Navigating to {ToPath}", toPath);
            Shell.NavigateTo(toPath);
        });
    }

}
