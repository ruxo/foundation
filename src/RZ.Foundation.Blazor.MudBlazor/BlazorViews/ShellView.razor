@typeparam T where T: RZ.Foundation.Blazor.MVVM.ViewModel

@using Microsoft.Extensions.DependencyInjection
@using RZ.Foundation.Blazor.Layout
@using RZ.Foundation.BlazorViews.Shells
@using Microsoft.AspNetCore.Components.Sections
@using RZ.Foundation.Blazor
@inherits ReactiveUI.Blazor.ReactiveInjectableComponentBase<RZ.Foundation.Blazor.Shells.ShellViewModel>

@inject IServiceProvider ServiceProvider

<MudThemeProvider Theme="Theme" @bind-IsDarkMode="ViewModel!.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider BackdropClick="false" NoHeader="true" />
<MudSnackbarProvider />

<MudLayout Class="screen-height">
    <ShellAppBar ViewModel="ViewModel" />
    <ShellNavMenu />
    <MudMainContent Class="max-height">
        <SectionOutlet SectionName="content-top"/>

        @if (ViewModel!.AppMode is AppMode.Page p && p.ContentWidth() is not null){
            <MudContainer MaxWidth="p.ContentWidth()!.Value" Class="max-height">
                <ShellViewContent ViewModel="ViewModel!"/>
            </MudContainer>
        }
        else{
            <ShellViewContent ViewModel="ViewModel!"/>
        }
    </MudMainContent>
</MudLayout>

@code {

    [Parameter] public AppMode? AppMode { get; set; }

    [Parameter] public bool IsDual { get; set; }

    [Parameter] public T? InitialViewModel { get; set; }

    [Parameter] public MudTheme? Theme { get; set; }

    protected override void OnParametersSet() {
        var vm = InitialViewModel ?? ActivatorUtilities.GetServiceOrCreateInstance<T>(ServiceProvider);
        var options = new ShellOptions {
            InitialView = vm,
            InitialAppMode = AppMode,
            IsDualMode = IsDual
        };
        ViewModel = ActivatorUtilities.CreateInstance<ShellViewModel>(ServiceProvider, options);
        base.OnParametersSet();
    }

}
